import boto3

def lambda_handler(event, context):
    # Create a CloudTrail client
    cloudtrail = boto3.client('cloudtrail')

    # Get the events from the CloudTrail event history
    response = cloudtrail.lookup_events(
        LookupAttributes=[
            {
                'AttributeKey': 'EventName',
                'AttributeValue': 'CreateFunction'  # Filter events for Lambda function creation
            },
        ],
        MaxResults=50  # Adjust the number of events to retrieve as per your requirement
    )

    # Initialize variables for storing function information
    function_info = []

    # Loop through the events and retrieve function information
    for event in response['Events']:
        event_name = event['EventName']
        user_identity = event['UserIdentity']
        function_name = event['Resources'][0]['ResourceName']
        role_arn = event['Resources'][0]['ARN']
        tags = event['Resources'][0].get('Tags', [])

        function_info.append({
            'EventName': event_name,
            'User': user_identity['Arn'],
            'FunctionName': function_name,
            'RoleARN': role_arn,
            'Tags': tags
        })

    # Prepare the email body
    email_body = "Lambda Function Creation Report:\n\n"
    for info in function_info:
        email_body += f"Event Name: {info['EventName']}\n"
        email_body += f"User: {info['User']}\n"
        email_body += f"Function Name: {info['FunctionName']}\n"
        email_body += f"Role ARN: {info['RoleARN']}\n"
        email_body += f"Tags: {info['Tags']}\n\n"

    # Create an SES client
    ses = boto3.client('ses')

    # Send the email
    ses.send_email(
        Source='sender@example.com',  # Replace with the sender email address
        Destination={
            'ToAddresses': ['recipient@example.com']  # Replace with the recipient email address(es)
        },
        Message={
            'Subject': {
                'Data': 'Lambda Function Creation Report'
            },
            'Body': {
                'Text': {
                    'Data': email_body
                }
            }
        }
    )
