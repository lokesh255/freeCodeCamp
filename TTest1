import boto3
from datetime import datetime, timedelta
from botocore.exceptions import ClientError

# Configure AWS services
ses_client = boto3.client('ses')
cloudtrail_client = boto3.client('cloudtrail')

# Email configuration
sender_email = 'your_sender_email@example.com'
recipient_email = 'your_recipient_email@example.com'
subject = 'Lambda Function Event History Report'

def send_email(subject, body):
    try:
        response = ses_client.send_email(
            Source=sender_email,
            Destination={
                'ToAddresses': [recipient_email]
            },
            Message={
                'Subject': {
                    'Data': subject
                },
                'Body': {
                    'Text': {
                        'Data': body
                    }
                }
            }
        )
        print("Email sent successfully!")
    except ClientError as e:
        print("Email sending failed: ", e.response['Error']['Message'])

def lambda_handler(event, context):
    function_report = ''

    try:
        response = cloudtrail_client.lookup_events(
            LookupAttributes=[
                {'AttributeKey': 'ResourceType', 'AttributeValue': 'AWS::Lambda::Function'}
            ],
            MaxResults=50,  # Adjust the value based on your needs
            StartTime=(datetime.now() - timedelta(days=1)).isoformat(),
            EndTime=datetime.now().isoformat()
        )

        for event in response['Events']:
            resources = event['Resources']

            for resource in resources:
                resource_name = resource['ResourceName']
                event_name = event['EventName']
                role_arn = event['UserIdentity']['Arn']
                attached_role = event['UserIdentity']['SessionContext']['SessionIssuer']['Arn']
                tags = resource.get('Tags', [])

                report_line = f"Resource Name: {resource_name}\n" \
                              f"Event Name: {event_name}\n" \
                              f"Assumed Role ARN: {role_arn}\n" \
                              f"Attached Role: {attached_role}\n" \
                              f"Tags: {tags}\n\n"

                function_report += report_line

        if function_report:
            send_email(subject, function_report)
        else:
            print("No Lambda function event history found.")

    except Exception as e:
        print("Error: ", e)
