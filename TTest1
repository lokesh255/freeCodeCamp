import boto3

def lambda_handler(event, context):
    # AWS SES configuration
    ses_region = 'us-west-2'  # Replace with your SES region
    sender_email = 'sender@example.com'  # Replace with your sender email address
    recipient_email = 'recipient@example.com'  # Replace with your recipient email address

    # AWS CloudTrail configuration
    trail_name = 'my-cloudtrail'  # Replace with your CloudTrail trail name

    # AWS IAM configuration
    tag_key = 'my-tag-key'  # Replace with your desired tag key

    # Initialize AWS clients
    cloudtrail = boto3.client('cloudtrail')
    iam = boto3.client('iam')
    ses = boto3.client('ses', region_name=ses_region)

    # Retrieve CloudTrail events
    response = cloudtrail.lookup_events(
        LookupAttributes=[
            {'AttributeKey': 'EventName', 'AttributeValue': 'CreateFunction'},
            {'AttributeKey': 'ResourceType', 'AttributeValue': 'AWS::Lambda::Function'}
        ],
        MaxResults=50  # Adjust MaxResults as needed
    )

    lambda_creations = []
    for event in response['Events']:
        event_username = event['Username']
        resources = event['Resources']
        for resource in resources:
            if resource['ResourceType'] == 'AWS::Lambda::Function':
                role_arn = resource['ARN']
                role_name = role_arn.split('/')[-1]

                role_response = iam.get_role(RoleName=role_name)
                role_tags = role_response['Role']['Tags']

                role_has_tag = any(tag['Key'] == tag_key for tag in role_tags)

                lambda_creation_info = {
                    'EventTime': str(event['EventTime']),
                    'EventUsername': event_username,
                    'RoleName': role_name,
                    'RoleHasTag': role_has_tag
                }
                lambda_creations.append(lambda_creation_info)

    # Print Lambda creation logs
    print("Lambda Function Creation Report:\n")
    for lambda_function in lambda_creations:
        print(f"Event Time: {lambda_function['EventTime']}")
        print(f"Event Username: {lambda_function['EventUsername']}")
        print(f"Role Name: {lambda_function['RoleName']}")
        print(f"Role Has Tag: {lambda_function['RoleHasTag']}")
        print("---------------------------------------------")

    # Create email report body
    email_body = "Lambda Function Creation Report:\n\n"
    for lambda_function in lambda_creations:
        email_body += f"Event Time: {lambda_function['EventTime']}\n"
        email_body += f"Event Username: {lambda_function['EventUsername']}\n"
        email_body += f"Role Name: {lambda_function['RoleName']}\n"
        email_body += f"Role Has Tag: {lambda_function['RoleHasTag']}\n"
        email_body += "---------------------------------------------\n"

    # Send email using AWS SES
    email_subject = "Lambda Function Creation Report"
    response = ses.send_email(
        Source=sender_email,
        Destination={
            'ToAddresses': [recipient_email]
        },
        Message={
            'Subject': {'Data': email_subject},
            'Body': {'Text': {'Data': email_body}}
        }
    )

    return {
        'statusCode': 200,
        'body': 'Email sent successfully!'
    }
