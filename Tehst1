import boto3

def send_email(subject, body):
    ses_client = boto3.client('ses', region_name='us-west-2')  # Replace with your desired AWS region

    # Replace with your email addresses
    sender_email = 'sender@example.com'
    recipient_email = 'recipient@example.com'

    # Create the email message
    email_message = {
        'Subject': {'Data': subject},
        'Body': {'Text': {'Data': body}},
    }

    # Send the email
    response = ses_client.send_email(
        Source=sender_email,
        Destination={'ToAddresses': [recipient_email]},
        Message=email_message
    )

    print('Email sent successfully')
    print('Message ID:', response['MessageId'])


def lambda_handler(event, context):
    # Initialize the AWS clients
    cloudtrail_client = boto3.client('cloudtrail')
    ecs_client = boto3.client('ecs')

    # Retrieve the ECS service creation events from CloudTrail
    response = cloudtrail_client.lookup_events(
        LookupAttributes=[
            {'AttributeKey': 'EventName', 'AttributeValue': 'CreateService'},
            {'AttributeKey': 'EventName', 'AttributeValue': 'RunTask'},  # Additional event type for ECS
        ]
    )

    # Prepare the email body
    body = 'ECS Service Creation Report:\n\n'

    for event in response['Events']:
        event_name = event['EventName']
        if event_name == 'CreateService':
            username = event['Username']
            assume_role_arn = event['Resources'][0]['ARN']
            ecs_name = event['Resources'][0]['ResourceName']
        elif event_name == 'RunTask':  # Additional event type for ECS
            username = event['Username']
            assume_role_arn = event['Resources'][0]['containerInstanceArn']
            ecs_name = event['Resources'][0]['containers'][0]['name']
        else:
            continue

        # Check if ECS service has tags
        response = ecs_client.describe_services(
            cluster='your-cluster-name',
            services=[ecs_name]
        )
        has_tags = 'tags' in response['services'][0]

        body += f'ECS Service: {ecs_name}\n'
        body += f'Created By: {username}\n'
        body += f'Assumed Role: {assume_role_arn}\n'
        body += f'Has Tags: {has_tags}\n\n'

    # Send the email
    subject = 'ECS Service Creation Report'
    send_email(subject, body)
