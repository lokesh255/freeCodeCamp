import boto3

def send_email(subject, body):
    ses_client = boto3.client('ses', region_name='us-west-2')  # Replace with your desired AWS region

    # Replace with your email addresses
    sender_email = 'sender@example.com'
    recipient_email = 'recipient@example.com'

    # Create the email message
    email_message = {
        'Subject': {'Data': subject},
        'Body': {'Text': {'Data': body}},
    }

    # Send the email
    response = ses_client.send_email(
        Source=sender_email,
        Destination={'ToAddresses': [recipient_email]},
        Message=email_message
    )

    print('Email sent successfully')
    print('Message ID:', response['MessageId'])


def lambda_handler(event, context):
    # Initialize the AWS clients
    cloudtrail_client = boto3.client('cloudtrail')
    s3_client = boto3.client('s3')

    # Retrieve the S3 bucket creation events from CloudTrail
    response = cloudtrail_client.lookup_events(
        LookupAttributes=[{'AttributeKey': 'EventName', 'AttributeValue': 'CreateBucket'}]
    )

    # Prepare the email body
    body = 'S3 Bucket Creation Report:\n\n'

    for event in response['Events']:
        event_name = event['EventName']
        if event_name == 'CreateBucket':
            username = event['Username']
            assume_role_arn = event['UserIdentity']['SessionContext']['SessionIssuer']['Arn']
            bucket_name = event['Resources'][0]['ResourceName']
        else:
            continue

        # Check if S3 bucket has tags
        try:
            response = s3_client.get_bucket_tagging(Bucket=bucket_name)
            has_tags = 'TagSet' in response
        except s3_client.exceptions.NoSuchTagSet:
            has_tags = False

        body += f'S3 Bucket: {bucket_name}\n'
        body += f'Created By: {username}\n'
        body += f'Assumed Role: {assume_role_arn}\n'
        body += f'Has Tags: {has_tags}\n\n'

    # Send the email
    subject = 'S3 Bucket Creation Report'
    send_email(subject, body)
