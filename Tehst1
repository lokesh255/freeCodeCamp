import boto3

def send_email(subject, body):
    ses_client = boto3.client('ses', region_name='us-west-2')  # Replace with your desired AWS region

    # Replace with your email addresses
    sender_email = 'sender@example.com'
    recipient_email = 'recipient@example.com'

    # Create the email message
    email_message = {
        'Subject': {'Data': subject},
        'Body': {'Text': {'Data': body}},
    }

    # Send the email
    response = ses_client.send_email(
        Source=sender_email,
        Destination={'ToAddresses': [recipient_email]},
        Message=email_message
    )

    print('Email sent successfully')
    print('Message ID:', response['MessageId'])


def lambda_handler(event, context):
    # Prepare the email body
    body = 'S3 Bucket Creation Report:\n\n'

    for record in event['Records']:
        event_name = record['eventName']
        if event_name == 'CreateBucket':
            user_identity = record.get('userIdentity', {})
            username = user_identity.get('userName', '')
            assume_role_arn = user_identity.get('sessionContext', {}).get('sessionIssuer', {}).get('arn', '')
            region = record['awsRegion']
            bucket_name = record['requestParameters'].get('bucketName', '')

            body += f'Event Name: {event_name}\n'
            body += f'Username: {username}\n'
            body += f'Assumed Role: {assume_role_arn}\n'
            body += f'Region: {region}\n'
            body += f'S3 Bucket: {bucket_name}\n\n'

    # Send the email
    subject = 'S3 Bucket Creation Report'
    send_email(subject, body)
