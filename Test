import boto3
from botocore.exceptions import ClientError

def send_email(sender, recipient, subject, body):
    # Create a new SES client
    ses_client = boto3.client('ses')

    # Send email
    try:
        response = ses_client.send_email(
            Source=sender,
            Destination={'ToAddresses': [recipient]},
            Message={
                'Subject': {'Data': subject},
                'Body': {'Text': {'Data': body}}
            }
        )
    except ClientError as e:
        print(f"Email sending failed: {e.response['Error']['Message']}")
        return False
    else:
        print(f"Email sent! Message ID: {response['MessageId']}")
        return True


def lambda_handler(event, context):
    # Initialize the AWS clients
    cloudtrail_client = boto3.client('cloudtrail')
    iam_client = boto3.client('iam')

    # Get the CloudTrail logs
    response = cloudtrail_client.lookup_events()

    # Extract the relevant information
    logs = response['Events']
    service_logs = []

    for log in logs:
        event_name = log['EventName']
        if event_name == 'CreateService':
            service_name = log['ServiceName']
            role_arn = log['IAMRole']
            try:
                role_name = iam_client.get_role(RoleArn=role_arn)['Role']['RoleName']
            except ClientError as e:
                print(f"Failed to retrieve IAM role: {e.response['Error']['Message']}")
                role_name = 'Unknown'
            service_logs.append({'ServiceName': service_name, 'RoleName': role_name})

    # Prepare the email body
    email_body = "CloudTrail logs for service creation and associated IAM roles:\n\n"
    for log in service_logs:
        email_body += f"Service Name: {log['ServiceName']}, Role Name: {log['RoleName']}\n"

    # Send the email
    sender = 'your-email@example.com'
    recipient = 'recipient-email@example.com'
    subject = 'CloudTrail Service Creation Log'
    
    send_email(sender, recipient, subject, email_body)

    # Return the service logs
    return service_logs
